#!/bin/bash
# IceNet-OS Boot Menu
# Offers choice between GUI and Shell at boot
# Defaults to shell if no input within timeout

set -e

TIMEOUT=10
CHOICE=""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Clear screen and show banner
clear
echo -e "${CYAN}"
cat << 'EOF'
  ___          _  _      _     ___  ___
 |_ _|__ ___ _| \| |___ | |_  / _ \/ __|
  | |/ _/ -_)_| .` / -_)|  _|| (_) \__ \
 |___\__\___(_)_|\_\___| \__| \___/|___/

EOF
echo -e "${NC}"
echo -e "${BOLD}IceNet-OS Boot Menu${NC}"
echo -e "Version: $(cat /etc/icenet-version 2>/dev/null || echo '0.1.0')"
echo ""
echo -e "${GREEN}═══════════════════════════════════════${NC}"
echo ""
echo "  1) ${BOLD}Console Shell${NC} (Default)"
echo "     Headless command-line environment"
echo "     Memory usage: ~50MB"
echo ""
echo "  2) ${BOLD}Desktop GUI${NC}"
echo "     Full graphical environment"
echo "     Memory usage: ~150MB"
echo ""
echo -e "${GREEN}═══════════════════════════════════════${NC}"
echo ""
echo -e "Select option [1-2] or wait ${TIMEOUT}s for default (Shell): \c"

# Read with timeout
if read -t $TIMEOUT -n 1 CHOICE; then
    echo ""
else
    echo ""
    CHOICE="1"
fi

# Process choice
case "$CHOICE" in
    2)
        echo ""
        echo -e "${BLUE}Starting Desktop GUI...${NC}"
        echo -e "Please wait while the graphical environment loads."
        sleep 1

        # Check if X is already running
        if pgrep -x "X" > /dev/null; then
            echo "X server already running"
            exit 0
        fi

        # Start display manager or X directly
        if command -v lightdm >/dev/null 2>&1; then
            exec sudo systemctl start lightdm
        elif command -v startx >/dev/null 2>&1; then
            exec startx
        else
            echo -e "${RED}Error: Desktop environment not installed${NC}"
            echo "Install with: cd integrations && sudo ./install-integrations.sh --desktop"
            sleep 3
            CHOICE="1"
        fi
        ;;
    1|*)
        echo ""
        echo -e "${GREEN}Starting Console Shell...${NC}"
        sleep 0.5
        # Continue normal boot to shell
        ;;
esac

# If we get here, continue to normal login
exit 0
